{
  "name": "Dynamics Activity Timeline",
  "version": "2.7.0",
  "description": "",
  "category": "Generic.ActivityTimeline",
  "language": "html",
  "status": "working",
  "tags": [],
  "timestamp": "2026-02-05T20:01:15.046Z",
  "code": "<!--\n * ============================================================\n * VERSION CONTROL BLOCK ‚Äî AUTHORITATIVE BASELINE\n * ============================================================\n * Component: Dynamics Activity Timeline (Single-File Web Resource)\n *\n * Baseline Version: v2.7.0\n * Status: STABLE / GCC HARDENED / UI REFINED\n *\n * Last Confirmed State:\n * - Journey + List dual-view implementation\n * - Intelligence Panel with tag-safe rich-text interpretation\n * - v2.7.0 Update: Restored Diagnostic Tray at bottom (Tray UI).\n * - v2.7.0 Update: Removed 'Open Record' button from Intel Panel.\n * - v2.7.0 Update: GCC Detection (Hides 'New Tab' on crm9).\n * - v2.7.0 Update: Scope-Lock for all handlers.\n *\n * Architectural Invariants (DO NOT BREAK):\n * - Helper functions MUST be window-scoped (UCI frame safety).\n * - Record context prioritized from URL & Opener as per v1.9.5.\n * - Hide Popout Tab button if URL contains '.crm9.'.\n * ============================================================\n-->\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n    <title>Dynamics Activity Timeline</title>\n\n    <style>\n        :root {\n            --dn-blue: #0078d4;\n            --dn-blue-hover: #005a9e;\n            --dn-neutral-primary: #323130;\n            --dn-neutral-secondary: #605e5c;\n            --dn-neutral-lighter: #f3f2f1;\n            --dn-neutral-light: #edebe9;\n            --dn-white: #ffffff;\n            --dn-border-radius: 4px;\n            --dn-shadow: 0 1.6px 3.6px rgba(0,0,0,0.132), 0 0.3px 0.9px rgba(0,0,0,0.108);\n            \n            --state-completed: #107c10;\n            --state-open: #ffaa44;\n            --state-canceled: #a19f9d;\n\n            --track-color: #d2d0ce;\n            --node-size: 34px;\n            --lane-max: 12;\n        }\n\n        html, body {\n            height: 100%; margin: 0;\n            font-family: \"Segoe UI\", -apple-system, sans-serif;\n            background-color: var(--dn-white);\n            color: var(--dn-neutral-primary);\n            overflow: hidden;\n        }\n\n        .skip-link { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; background: var(--dn-blue); color: white; z-index: 10000; }\n        .skip-link:focus { position: fixed; left: 10px; top: 10px; width: auto; height: auto; padding: 10px 20px; border-radius: 4px; outline: 3px solid white; }\n\n        .container {\n            display: flex; flex-direction: column; height: 100vh;\n            padding: 15px; box-sizing: border-box; gap: 10px;\n            position: relative;\n        }\n\n        /* Animated Close 'X' */\n        .btn-close-canvas {\n            position: absolute; top: 15px; right: 15px;\n            width: 32px; height: 32px; border-radius: 50%;\n            background: var(--dn-white); border: 1px solid var(--dn-neutral-light);\n            display: none; align-items: center; justify-content: center;\n            cursor: pointer; z-index: 2000; transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);\n            color: var(--dn-neutral-secondary);\n            box-shadow: var(--dn-shadow);\n        }\n        .btn-close-canvas:hover { \n            background: #fde7e9; \n            color: #d13438; \n            border-color: #d13438; \n            transform: rotate(90deg) scale(1.1);\n        }\n        .btn-close-canvas svg { width: 18px; height: 18px; }\n\n        /* v2.7.0 Integrated Diagnostic Bottom Tray */\n        #diagnosticConsole {\n            position: fixed; bottom: 40px; left: 0; right: 0;\n            height: 220px; background: #1e1e1e; color: #d4d4d4; \n            padding: 0; z-index: 4000; display: none; flex-direction: column; \n            font-family: \"Consolas\", monospace; font-size: 11px;\n            box-shadow: 0 -5px 15px rgba(0,0,0,0.3); border-top: 1px solid #444;\n        }\n        .diag-header { \n            display: flex; justify-content: space-between; align-items: center; \n            background: #333; padding: 6px 15px; border-bottom: 1px solid #444; flex-shrink: 0;\n        }\n        .diag-log { flex: 1; overflow-y: auto; white-space: pre-wrap; line-height: 1.4; padding: 10px 15px; }\n        .log-err { color: #f1707b; font-weight: bold; }\n        .log-success { color: #89d185; }\n\n        .header {\n            display: flex; justify-content: space-between; align-items: flex-start;\n            border-bottom: 1px solid var(--dn-neutral-light); padding-bottom: 10px;\n            flex-shrink: 0; gap: 15px; flex-wrap: wrap; padding-right: 45px;\n        }\n        .title-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }\n        .main-title { font-size: 17px; font-weight: 600; white-space: nowrap; }\n        .record-name-subtitle { font-size: 13px; color: var(--dn-neutral-secondary); font-weight: 400; padding-left: 10px; border-left: 2px solid var(--dn-neutral-light); max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n\n        .tab-switcher { display: flex; background: var(--dn-neutral-lighter); padding: 3px; border-radius: 8px; border: 1px solid var(--dn-neutral-light); margin-left: 5px; }\n        .tab-btn { padding: 4px 16px; font-size: 13px; border: none; background: none; cursor: pointer; border-radius: 4px; color: var(--dn-neutral-secondary); transition: all 0.2s; }\n        .tab-btn.active { background: var(--dn-white); color: var(--dn-blue); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }\n\n        .badge { font-size: 11px; background: var(--dn-blue); color: white; padding: 2px 10px; border-radius: 12px; font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.2); line-height: 1; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; }\n\n        .filter-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 4px 0; flex-shrink: 0; }\n        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }\n        \n        .type-chip { padding: 4px 14px; border-radius: 16px; font-size: 12px; background: var(--dn-white); border: 1px solid var(--dn-neutral-light); cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s ease; user-select: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }\n        .type-chip.active { background: var(--dn-neutral-primary); color: var(--dn-white); border-color: var(--dn-neutral-primary); font-weight: 600; }\n\n        .control-group { display: flex; align-items: center; gap: 8px; background: var(--dn-neutral-lighter); padding: 4px 14px; border-radius: 24px; border: 1px solid var(--dn-neutral-light); flex-wrap: wrap; }\n        input[type=\"text\"] { padding: 6px 14px; border: 1px solid var(--dn-neutral-light); border-radius: 18px; font-size: 13px; width: 180px; outline: none; transition: border-color 0.2s; }\n        \n        .content-grid { display: grid; grid-template-columns: minmax(0, 1fr) 340px; gap: 16px; flex: 1; min-height: 0; overflow: hidden; }\n        .panel { background: var(--dn-white); border: 1px solid var(--dn-neutral-light); border-radius: var(--dn-border-radius); display: flex; flex-direction: column; overflow: hidden; }\n        .panel-header { padding: 10px 16px; background: var(--dn-neutral-lighter); font-weight: 600; font-size: 11px; border-bottom: 1px solid var(--dn-neutral-light); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }\n\n        .details-body { padding: 0; overflow-y: auto; background: var(--dn-white); flex: 1; scrollbar-width: thin; }\n        .detail-section { padding: 14px; }\n        .detail-card { background: var(--dn-neutral-lighter); border: 1px solid var(--dn-neutral-light); border-radius: 6px; padding: 12px; margin-bottom: 12px; }\n        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; padding-top: 12px; border-top: 1px solid var(--dn-neutral-light); }\n        .detail-item { display: flex; flex-direction: column; gap: 8px; } \n        .detail-label { font-size: 9px; font-weight: 800; color: var(--dn-neutral-secondary); text-transform: uppercase; letter-spacing: 0.6px; opacity: 0.8; }\n        .detail-value { font-size: 11px; font-weight: 600; color: var(--dn-neutral-primary); line-height: 1.2; }\n        \n        .readability-controls { display: flex; gap: 4px; background: var(--dn-neutral-light); padding: 2px; border-radius: 4px; }\n        .readability-btn { padding: 2px 8px; font-size: 10px; border: none; background: none; cursor: pointer; border-radius: 2px; transition: all 0.15s; }\n        .readability-btn.active { background: white; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }\n        \n        .detail-description-html { line-height: 1.5; word-wrap: break-word; font-size: 12px; color: var(--dn-neutral-secondary); margin-top: 12px; }\n        .font-sz-sm { font-size: 11px !important; }\n        .font-sz-md { font-size: 13px !important; }\n        .font-sz-lg { font-size: 16px !important; }\n\n        .timeline-viewport { flex: 1; overflow: auto; position: relative; background: #fff; background-image: radial-gradient(var(--dn-neutral-light) 1px, transparent 0); background-size: 40px 40px; outline: none; }\n        .timeline-track { position: absolute; top: 60px; left: 50px; right: 50px; height: 2px; background: var(--track-color); z-index: 1; }\n        .node { position: absolute; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; cursor: pointer; z-index: 2; outline: none; transition: transform 0.2s; }\n        .node:hover { transform: translate(-50%, -50%) scale(1.05); z-index: 10; }\n        .node-icon { width: var(--node-size); height: var(--node-size); background: white; border: 2.5px solid var(--dn-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: var(--dn-shadow); flex-shrink: 0; }\n        .node-side-meta { display: flex; flex-direction: column; font-size: 10px; line-height: 1.1; background: rgba(255,255,255,0.9); padding: 4px 6px; border-radius: 4px; white-space: nowrap; border: 1px solid var(--dn-neutral-light); }\n        .node-label { margin-top: 8px; font-size: 11px; font-weight: 600; text-align: center; color: var(--dn-neutral-primary); background: rgba(255,255,255,0.95); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--dn-neutral-light); box-shadow: 0 1px 2px rgba(0,0,0,0.05); max-width: 100px; white-space: normal; word-wrap: break-word; line-height: 1.1; }\n\n        .list-viewport { flex: 1; overflow-y: auto; padding: 20px; background: var(--dn-neutral-lighter); min-height: 300px; }\n        .list-item { display: flex; gap: 16px; position: relative; padding-bottom: 24px; align-items: flex-start; }\n        .list-card { flex: 1; background: white; border: 1px solid var(--dn-neutral-light); border-radius: 4px; padding: 12px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; outline: none; }\n\n        .btn { height: 28px; padding: 0 14px; font-size: 12px; background: var(--dn-white); border: 1px solid var(--dn-neutral-light); border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; gap: 6px; white-space: nowrap; }\n        .btn.primary { background: var(--dn-blue); color: white; border: none; }\n        .btn.outline { border: 1px solid var(--dn-blue); color: var(--dn-blue); }\n        .btn-icon-only { padding: 0; width: 34px; border-radius: 50%; }\n\n        .footer-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; flex-shrink: 0; border-top: 1px solid var(--dn-neutral-light); background: var(--dn-neutral-lighter); }\n        .version-tag { font-size: 10px; color: var(--dn-neutral-secondary); opacity: 0.8; user-select: none; display: flex; align-items: center; gap: 10px; }\n        .btn-debug { font-size: 9px; padding: 2px 8px; border: 1px solid #ccc; background: #eee; cursor: pointer; border-radius: 3px; font-weight: bold; }\n        .data-status-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; border: 1px solid transparent; }\n        .status-live { background: #dff6dd; color: #107c10; border-color: #107c10; }\n        .status-sample { background: #fff4ce; color: #797775; border-color: #797775; }\n\n        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 10px; font-weight: 600; }\n        #notificationHost { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 5px; }\n        .notification { background: #323130; color: white; padding: 12px 16px; border-radius: 4px; font-size: 11px; box-shadow: var(--dn-shadow); }\n        .highlight-mark { background-color: #fff100; color: black; font-weight: bold; border-radius: 2px; padding: 0 1px; }\n    </style>\n</head>\n\n<body>\n    <a href=\"#viewport\" class=\"skip-link\">Skip to timeline content</a>\n    <div id=\"notificationHost\"></div>\n\n    <!-- v2.7.0 Integrated Diagnostic Bottom Tray -->\n    <div id=\"diagnosticConsole\">\n        <div class=\"diag-header\">\n            <strong>GCC Stability & Filter Log</strong>\n            <div style=\"display:flex; gap:5px\">\n                <button class=\"btn\" style=\"background:#0078d4; color:white; border:none;\" onclick=\"window.copyLogs()\">Copy Logs</button>\n                <button class=\"btn\" style=\"background:none; color:white; border:1px solid #666;\" onclick=\"window.toggleDiagnostics()\">Close</button>\n            </div>\n        </div>\n        <div class=\"diag-log\" id=\"diagLog\">App Initialized...</div>\n    </div>\n\n    <div class=\"container\">\n        <!-- Close 'X' Button -->\n        <button class=\"btn-close-canvas\" id=\"btnCloseWindow\" title=\"Close this timeline view\">\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg>\n        </button>\n\n        <header class=\"header\">\n            <div class=\"title-group\">\n                <span class=\"main-title\">Activity Journey</span>\n                <span id=\"recordNameSubtitle\" class=\"record-name-subtitle\" style=\"display:none\"></span>\n                <span id=\"countBadge\" class=\"badge\" title=\"Total interaction count\">0</span>\n                <div class=\"tab-switcher\" role=\"tablist\">\n                    <button class=\"tab-btn active\" id=\"tabJourney\" title=\"Visual Timeline\" onclick=\"window.switchTab('journey')\">Journey</button>\n                    <button class=\"tab-btn\" id=\"tabList\" title=\"Data Feed\" onclick=\"window.switchTab('list')\">List</button>\n                </div>\n            </div>\n\n            <div class=\"control-group\">\n                <div class=\"control-item\">\n                    <label for=\"daysFilter\">Range:</label>\n                    <select id=\"daysFilter\" onchange=\"window.handleFilterChange()\" style=\"border:none; background:transparent; font-weight:600; cursor:pointer; font-size:12px;\">\n                        <option value=\"7\">7 Days</option>\n                        <option value=\"30\" selected>30 Days</option>\n                        <option value=\"90\">90 Days</option>\n                        <option value=\"365\">1 Year</option>\n                    </select>\n                </div>\n                <div class=\"control-item\">\n                    <input type=\"range\" id=\"zoomSlider\" min=\"800\" max=\"4000\" step=\"100\" value=\"1000\" oninput=\"window.handleZoomChange()\">\n                </div>\n                <div class=\"control-item\">\n                    <label style=\"cursor:pointer; display:flex; align-items:center; gap:4px\">\n                        <input type=\"checkbox\" id=\"timeToggle\" onchange=\"window.handleTimeToggle()\">\n                        <span>Time</span>\n                    </label>\n                </div>\n                <button class=\"btn outline\" id=\"btnExport\" title=\"Export matching records\">Export</button>\n                <div style=\"display:flex; gap:4px;\" id=\"popoutControls\">\n                    <button class=\"btn outline btn-icon-only\" id=\"btnPopoutTab\" title=\"Open in new browser tab\">\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><path d=\"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6\"></path><polyline points=\"15 3 21 3 21 9\"></polyline><line x1=\"10\" x2=\"21\" y1=\"14\" y2=\"3\"></line></svg>\n                    </button>\n                    <button class=\"btn outline btn-icon-only\" id=\"btnPopoutDialog\" title=\"Open in focused modal\">\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect><line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"></line></svg>\n                    </button>\n                </div>\n                <button class=\"btn primary\" id=\"btnSync\" title=\"Sync interactions from Dataverse\">Sync</button>\n            </div>\n        </header>\n\n        <div class=\"filter-row\">\n            <div id=\"typeFilters\" class=\"filter-chips\"></div>\n            <input type=\"text\" id=\"searchInput\" placeholder=\"Search interactions... (Ctrl+K)\" oninput=\"window.handleSearch()\">\n        </div>\n\n        <div class=\"content-grid\">\n            <section class=\"panel\">\n                <div class=\"panel-header\">\n                    <span id=\"dateRange\">Ready</span>\n                    <span id=\"statusBadge\" role=\"status\" style=\"font-weight:normal; color:var(--dn-neutral-secondary)\">Initialized</span>\n                </div>\n                <div id=\"viewJourney\" style=\"display:flex; flex-direction:column; flex:1; min-height:0;\">\n                    <div class=\"top-scrollbar-wrapper\" id=\"topScrollWrapper\"><div id=\"topScrollDummy\" style=\"height:1px;\"></div></div>\n                    <div class=\"timeline-viewport\" id=\"viewport\" tabindex=\"0\">\n                        <div id=\"timelineCanvas\" style=\"position:relative; height:100%; min-width:1000px; padding-bottom: 120px;\">\n                            <div class=\"timeline-track\"></div>\n                        </div>\n                    </div>\n                </div>\n                <div id=\"viewList\" class=\"list-viewport\" style=\"display:none;\">\n                    <div id=\"listContent\" role=\"feed\"></div>\n                </div>\n            </section>\n\n            <aside class=\"panel\">\n                <div class=\"panel-header\">\n                    <span>Intelligence Panel</span>\n                    <div class=\"readability-controls\" id=\"readabilityCtrl\" style=\"visibility:hidden\">\n                        <button class=\"readability-btn\" onclick=\"window.setFontSize('sm', this)\">A-</button>\n                        <button class=\"readability-btn active\" onclick=\"window.setFontSize('md', this)\">A</button>\n                        <button class=\"readability-btn\" onclick=\"window.setFontSize('lg', this)\">A+</button>\n                    </div>\n                </div>\n                <div id=\"detailsBody\" class=\"details-body\">\n                    <div class=\"detail-section\" id=\"detailsPlaceholder\">\n                        <p style=\"text-align:center; margin-top:40px; color:var(--dn-neutral-secondary)\">Select a record to analyze metadata.</p>\n                    </div>\n                    <div id=\"detailsContent\" style=\"display:none\"></div>\n                </div>\n            </aside>\n        </div>\n\n        <div class=\"footer-row\">\n            <div class=\"version-tag\">\n                Baseline v2.7.0\n                <button class=\"btn-debug\" onclick=\"window.toggleDiagnostics()\">Diagnostics</button>\n            </div>\n            <span id=\"dataStatusBadge\" class=\"data-status-badge status-sample\" title=\"Live means connected to Dynamics\">Validating Connection...</span>\n        </div>\n    </div>\n\n<script>\n    /** * GLOBAL ARCHITECTURAL LOCK v2.7.0\n     * Reverts to v1.9.5 discovery while hardening GCC button visibility.\n     * Restores bottom diagnostic tray and streamlines interaction buttons.\n     */\n    \n    let searchTimeout;\n    const MAX_LANES = 12;\n    const EXPORT_CAP = 500;\n\n    const STATE = { \n        nodes: [], canvasWidth: 1000, daysFilter: 30, showTime: false,\n        activeTab: 'journey', searchQuery: \"\", activeDisplayNames: new Set(), \n        allDisplayNamesFound: new Set(), panelFontSize: 'md'\n    };\n\n    const ICONS = {\n        phonecall: \"üìû\", email: \"‚úâÔ∏è\", task: \"‚úÖ\", appointment: \"üìÖ\",\n        chat: \"üí¨\", system: \"‚öôÔ∏è\", custom: \"üß©\", ai_negative: \"üî¥\", ai_positive: \"üü¢\", ai_neutral: \"‚ö™\", \n        note: \"üìù\", letter: \"‚úâÔ∏è\", voicemail: \"üéôÔ∏è\", default: \"üìÑ\"\n    };\n\n    const ENTITY_MAP = {\n        4210: 'Phone Call', 4200: 'Email', 4202: 'Task', 4201: 'Appointment',\n        4216: 'Chat', 4207: 'Letter', 4214: 'Voicemail', 4204: 'Fax'\n    };\n\n    window.diagLog = (msg, type = 'info') => {\n        const el = document.getElementById('diagLog'); if (!el) return;\n        const div = document.createElement('div');\n        div.className = `log-${type}`;\n        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;\n        el.appendChild(div);\n        console.log(`[Timeline] ${msg}`);\n    };\n\n    /** v2.7.0 Environment Hardening: Immediate CSS Injection for GCC Signature */\n    window.applyEnvironmentPolicies = () => {\n        const url = window.location.href.toLowerCase();\n        if (url.includes(\".crm9.\") || url.includes(\"gov.content.microsoft\")) {\n            const style = document.createElement('style');\n            style.innerHTML = '#btnPopoutTab { display: none !important; }';\n            document.head.appendChild(style);\n            window.diagLog(\"GCC Detected. Hiding New Tab feature for security compliance.\", \"success\");\n        }\n    };\n\n    window.escapeRegExp = (str) => { return (str || \"\").replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); };\n\n    window.interpretHTML = (html, query) => {\n        if (!html) return \"\";\n        const doc = new DOMParser().parseFromString(html, 'text/html');\n        if (!doc || !doc.body) return String(html);\n        if (query && query.length > 2) {\n            const safeQuery = window.escapeRegExp(query);\n            const regex = new RegExp(`(${safeQuery})`, 'gi');\n            const highlightTextNodes = (node) => {\n                if (node.nodeType === 3) {\n                    const parent = node.parentNode;\n                    if (parent && parent.tagName !== 'MARK' && parent.tagName !== 'SCRIPT' && parent.tagName !== 'STYLE') {\n                        const originalText = node.nodeValue;\n                        if (regex.test(originalText)) {\n                            const span = document.createElement('span');\n                            span.innerHTML = originalText.replace(regex, '<mark class=\"highlight-mark\">$1</mark>');\n                            parent.replaceChild(span, node);\n                        }\n                    }\n                } else if (node.nodeType === 1) {\n                    for (let i = node.childNodes.length - 1; i >= 0; i--) {\n                        highlightTextNodes(node.childNodes[i]);\n                    }\n                }\n            };\n            highlightTextNodes(doc.body);\n        }\n        return doc.body.innerHTML;\n    };\n\n    window.sanitizeHTML = (str) => { if (!str) return \"\"; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; };\n    window.getInitials = (name) => { if (!name || typeof name !== 'string') return \"\"; return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2); };\n\n    window.safeGetXrm = () => {\n        try { if (window.Xrm && window.Xrm.WebApi) return window.Xrm; } catch(e) {}\n        try { if (window.parent && window.parent.Xrm && window.parent.Xrm.WebApi) return window.parent.Xrm; } catch (e) {}\n        try { if (window.opener && window.opener.Xrm && window.opener.Xrm.WebApi) return window.opener.Xrm; } catch (e) {}\n        try { if (window.opener && window.opener.parent && window.opener.parent.Xrm) return window.opener.parent.Xrm; } catch (e) {}\n        try { if (window.top && window.top.Xrm && window.top.Xrm.WebApi) return window.top.Xrm; } catch (e) {}\n        return null;\n    };\n\n    window.getUrlParameter = (name) => {\n        const params = new URLSearchParams(window.location.search);\n        if (params.has(name)) return params.get(name);\n        if (params.has('data')) {\n            const dataStr = params.get('data');\n            const dataParams = new URLSearchParams(dataStr);\n            if (dataParams.has(name)) return dataParams.get(name);\n            try {\n                const nested = new URLSearchParams(decodeURIComponent(dataStr));\n                if (nested.has(name)) return nested.get(name);\n            } catch(e){}\n        }\n        return null;\n    };\n\n    window.getTemporalContext = (date) => {\n        if (!date || isNaN(date.getTime())) return { d: \"Unknown\", t: \"\" };\n        const dStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });\n        const tStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n        return { d: dStr, t: tStr };\n    };\n\n    window.fetchPagedData = async (Xrm, entity, query, cap = EXPORT_CAP) => {\n        try {\n            let records = [];\n            let res = await Xrm.WebApi.retrieveMultipleRecords(entity, query);\n            records.push(...(res.entities || []));\n            while (res.nextLink && records.length < cap) {\n                const nextRel = res.nextLink.includes('?') ? '?' + res.nextLink.split('?')[1] : res.nextLink;\n                res = await Xrm.WebApi.retrieveMultipleRecords(entity, nextRel);\n                records.push(...(res.entities || []));\n            }\n            return records;\n        } catch(e) { return []; }\n    };\n\n    window.exportToCSV = () => {\n        try {\n            const query = STATE.searchQuery.toLowerCase();\n            const filtered = STATE.nodes.filter(n => n.source !== 'ai' && STATE.activeDisplayNames.has(n.displayName));\n            if (!filtered.length) { window.notify(\"No data to export.\"); return; }\n            const rows = filtered.slice(0, EXPORT_CAP).map(n => [ n.date ? n.date.toISOString() : \"\", (n.normalizedType || \"\").toUpperCase(), n.state || \"\", n.owner || \"\", n.title || \"\", (n.description || \"\").replace(/<[^>]*>?/gm, '') ]);\n            const csv = [\"Date,Type,Status,Owner,Subject,Description\", ...rows.map(r => r.map(c => `\"${String(c).replace(/\"/g, '\"\"')}\"`).join(\",\"))].join(\"\\n\");\n            const link = document.createElement(\"a\"); link.href = URL.createObjectURL(new Blob([csv], { type: \"text/csv\" }));\n            link.download = `Interaction_History_${new Date().toISOString().slice(0,10)}.csv`;\n            link.click(); window.notify(\"Export complete\");\n        } catch (error) { window.notify(\"Export failed\"); }\n    };\n\n    window.bootstrap = async () => {\n        const params = new URLSearchParams(window.location.search);\n        if (params.has('days')) STATE.daysFilter = params.get('days');\n        if (params.has('search')) STATE.searchQuery = params.get('search');\n        if (params.has('tab')) STATE.activeTab = params.get('tab');\n        \n        const isPoppedOut = params.has('popped') || !!window.opener;\n        if (isPoppedOut) {\n            document.getElementById('btnCloseWindow').style.display = 'flex';\n            document.getElementById('popoutControls').style.display = 'none';\n        }\n\n        const overlay = document.getElementById('loadingOverlay') || document.createElement('div');\n        overlay.id = 'loadingOverlay';\n        overlay.innerHTML = `<div style=\"font-size:32px;\">‚è≥</div><div>Syncing interactions...</div>`;\n        if (!document.getElementById('loadingOverlay')) document.body.appendChild(overlay);\n        \n        try {\n            const Xrm = window.safeGetXrm();\n            \n            // Context discovery priority\n            let regardingId = window.getUrlParameter('id') || window.getUrlParameter('recordId');\n            \n            if (!regardingId && Xrm?.Utility?.getPageContext) {\n                const pc = Xrm.Utility.getPageContext();\n                regardingId = pc?.input?.entityId || pc?.input?.recordId;\n            }\n            if (!regardingId && window.opener?.Xrm?.Page?.data?.entity) {\n                regardingId = window.opener.Xrm.Page.data.entity.getId();\n            }\n            if (!regardingId && Xrm?.Page?.data?.entity) {\n                regardingId = Xrm.Page.data.entity.getId();\n            }\n            \n            regardingId = regardingId ? regardingId.replace(/{|}/g, \"\").toLowerCase() : null;\n\n            if (Xrm && regardingId) {\n                const badge = document.getElementById('dataStatusBadge');\n                badge.innerText = \"Live Dataverse Link\"; badge.className = \"data-status-badge status-live\";\n                const startDate = new Date(); startDate.setDate(startDate.getDate() - Number(STATE.daysFilter));\n                \n                const isPopTab = params.has('popped');\n                \n                const actSelect = `$select=activityid,subject,description,createdon,scheduledstart,activitytypecode,statecode,actualdurationminutes,prioritycode,_regardingobjectid_value,_ownerid_value`;\n                const noteSelect = `$select=annotationid,subject,notetext,createdon,_ownerid_value`;\n\n                const activityQuery = isPopTab \n                    ? `?${actSelect}&$filter=(_regardingobjectid_value eq ${regardingId})&$orderby=createdon asc&$top=1000`\n                    : `?${actSelect}&$filter=(_regardingobjectid_value eq ${regardingId}) and (createdon ge ${startDate.toISOString()})&$orderby=createdon asc`;\n                \n                const noteQuery = isPopTab\n                    ? `?${noteSelect}&$filter=(_objectid_value eq ${regardingId})&$orderby=createdon asc&$top=1000`\n                    : `?${noteSelect}&$filter=(_objectid_value eq ${regardingId}) and (createdon ge ${startDate.toISOString()})&$orderby=createdon asc`;\n                \n                let [activities, notes] = await Promise.all([ window.fetchPagedData(Xrm, \"activitypointer\", activityQuery), window.fetchPagedData(Xrm, \"annotation\", noteQuery) ]);\n                \n                if (activities.length < 15 || notes.length < 15) {\n                    window.diagLog(\"Density check: Merging broad historical fallback...\");\n                    const broadAct = await window.fetchPagedData(Xrm, \"activitypointer\", `?${actSelect}&$filter=(_regardingobjectid_value eq ${regardingId})&$top=600`);\n                    activities = [...activities, ...broadAct.filter(ba => !activities.some(a => a.activityid === ba.activityid))];\n                }\n\n                const allRaw = [\n                    ...activities.map(a => ({\n                        id: String(a.activityid), title: a.subject || \"No Subject\", description: a.description || \"\",\n                        date: new Date(a.scheduledstart || a.createdon), rawType: a.activitytypecode, \n                        entityName: typeof a.activitytypecode === 'number' ? (ENTITY_MAP[a.activitytypecode]?.toLowerCase().replace(' ', '') || 'activitypointer') : a.activitytypecode,\n                        normalizedType: window.normalizeType(a.activitytypecode, a.subject, a.description),\n                        displayName: ENTITY_MAP[Number(a.activitytypecode)] || a[\"activitytypecode@OData.Community.Display.V1.FormattedValue\"] || \"Interaction\",\n                        source: 'dataverse', state: a[\"statecode@OData.Community.Display.V1.FormattedValue\"] || \"\",\n                        owner: a[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"] || \"Unknown\"\n                    })),\n                    ...notes.map(n => ({\n                        id: String(n.annotationid), title: n.subject || \"Note Entry\", description: n.notetext || \"No content.\",\n                        date: new Date(n.createdon), rawType: \"annotation\", normalizedType: \"note\", displayName: \"Note\",\n                        entityName: \"annotation\", source: 'dataverse', state: \"Notes\", owner: n[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"] || \"Unknown\", initials: window.getInitials(n[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"])\n                    }))\n                ];\n                STATE.nodes = allRaw.sort((a,b) => a.date - b.date);\n            } else { \n                STATE.nodes = window.getSampleData().sort((a,b) => a.date - b.date); \n                document.getElementById('dataStatusBadge').innerText = \"Demo Mode: ID Resolution Fail\";\n            }\n            \n            STATE.allDisplayNamesFound = new Set(STATE.nodes.map(n => n.displayName));\n            if (STATE.activeDisplayNames.size === 0) STATE.activeDisplayNames = new Set(STATE.allDisplayNamesFound);\n            const aiNodes = window.runHeuristics(STATE.nodes);\n            STATE.nodes = [...STATE.nodes, ...aiNodes].sort((a,b) => a.date - b.date);\n            \n            if (STATE.activeTab !== 'journey') window.switchTab(STATE.activeTab);\n            window.renderFilters(); window.render();\n            document.getElementById('statusBadge').innerText = `${STATE.nodes.filter(n=>n.source!=='ai').length} interaction(s) loaded`;\n        } catch (e) { \n            window.diagLog(`Sync failed: ${e.message}`, \"err\");\n            document.getElementById('statusBadge').innerText = \"Sync Error\"; \n        }\n        finally { if (document.getElementById('loadingOverlay')) document.getElementById('loadingOverlay').remove(); }\n    };\n\n    window.runHeuristics = (nodes) => {\n        const insights = [];\n        nodes.forEach(node => {\n            if (node.normalizedType === 'system' || node.normalizedType === 'note') return;\n            const text = (node.title + \" \" + node.description).toLowerCase();\n            const sentiment = text.includes(\"angry\") || text.includes(\"complaint\") ? 'negative' : (text.includes(\"thanks\") || text.includes(\"great\") ? 'positive' : null);\n            if (sentiment) {\n                insights.push({ id: `ai-${node.id}`, title: `AI Sentiment Insight`, date: new Date(node.date.getTime() + 1000 * 60 * 15), normalizedType: sentiment === 'negative' ? 'ai_negative' : 'ai_positive', source: 'ai', sentimentType: sentiment, displayName: \"AI Analysis\", description: `Detected ${sentiment} tone in this interaction.` });\n                node.sentimentType = sentiment;\n            }\n        });\n        return insights;\n    };\n\n    window.switchTab = (tab) => {\n        STATE.activeTab = tab;\n        document.getElementById('tabJourney').className = `tab-btn ${tab === 'journey' ? 'active' : ''}`;\n        document.getElementById('tabList').className = `tab-btn ${tab === 'list' ? 'active' : ''}`;\n        document.getElementById('viewJourney').style.display = tab === 'journey' ? 'flex' : 'none';\n        document.getElementById('viewList').style.display = tab === 'list' ? 'block' : 'none';\n        window.render();\n    };\n\n    window.renderFilters = () => {\n        const container = document.getElementById(\"typeFilters\");\n        container.innerHTML = \"\";\n        const counts = {}; \n        STATE.nodes.forEach(n => { if(n.source !== 'ai') counts[n.displayName] = (counts[n.displayName] || 0) + 1; });\n        const allBtn = document.createElement(\"button\");\n        const isShowingAll = STATE.activeDisplayNames.size === STATE.allDisplayNamesFound.size;\n        allBtn.className = `type-chip ${isShowingAll ? 'active' : ''}`;\n        allBtn.innerHTML = `Show All <span class=\"chip-count\">${Object.values(counts).reduce((a,b)=>a+b, 0)}</span>`;\n        allBtn.onclick = () => {\n            if (isShowingAll) { STATE.activeDisplayNames = new Set(); } \n            else { STATE.activeDisplayNames = new Set(STATE.allDisplayNamesFound); }\n            window.renderFilters(); window.render();\n        };\n        container.appendChild(allBtn);\n        Array.from(STATE.allDisplayNamesFound).sort().forEach(name => {\n            const chip = document.createElement(\"button\");\n            chip.className = `type-chip ${STATE.activeDisplayNames.has(name) ? 'active' : ''}`;\n            chip.innerHTML = `${window.sanitizeHTML(String(name))} <span class=\"chip-count\">${counts[name] || 0}</span>`;\n            chip.onclick = () => {\n                if (STATE.activeDisplayNames.has(name)) { STATE.activeDisplayNames.delete(name); }\n                else { STATE.activeDisplayNames.add(name); }\n                window.renderFilters(); window.render();\n            };\n            container.appendChild(chip);\n        });\n    };\n\n    window.render = () => {\n        const query = STATE.searchQuery.toLowerCase();\n        const filtered = STATE.nodes.filter(n => {\n            const matchSearch = (n.title + ' ' + n.description).toLowerCase().includes(query);\n            const matchType = n.source === 'ai' || STATE.activeDisplayNames.has(n.displayName);\n            return matchSearch && matchType;\n        });\n        document.getElementById('countBadge').innerText = filtered.filter(n=>n.source!=='ai').length;\n        if (STATE.activeTab === 'journey') renderJourney(filtered); else renderList(filtered);\n    };\n\n    function renderJourney(nodes) {\n        const canvas = document.getElementById(\"timelineCanvas\");\n        canvas.querySelectorAll('.node').forEach(n => n.remove());\n        if (!nodes.length) return;\n        try {\n            const totalNodes = nodes.length;\n            const start = nodes[0].date.getTime();\n            const end = nodes[totalNodes - 1].date.getTime();\n            const duration = end - start || 1;\n            const lanes = [];\n            const frag = document.createDocumentFragment();\n            nodes.forEach((node, index) => {\n                const posPct = (index / (totalNodes <= 1 ? 1 : totalNodes - 1)) * 75 + 12.5;\n                let laneIndex = 0; while ((lanes[laneIndex] ?? -999) > (posPct - 12) && laneIndex < (MAX_LANES - 1)) laneIndex++;\n                lanes[laneIndex] = posPct;\n                const nodeEl = document.createElement(\"div\");\n                nodeEl.className = \"node\"; nodeEl.style.left = `${posPct}%`; nodeEl.style.top = `${60 + (laneIndex * 115)}px`;\n                nodeEl.setAttribute('tabindex', '0');\n                nodeEl.addEventListener('click', () => window.showDetails(node));\n                const ctx = window.getTemporalContext(node.date);\n                nodeEl.innerHTML = `\n                    <div class=\"node-row\">\n                        <div class=\"node-icon\">${node.normalizedType === 'note' && node.initials ? `<span style=\"font-size:10px; font-weight:800\">${node.initials}</span>` : (ICONS[node.normalizedType] || ICONS.default)}</div>\n                        <div class=\"node-side-meta\"><strong>${ctx.d}</strong>${STATE.showTime ? `<span style=\"opacity:0.7\">${ctx.t}</span>` : ''}</div>\n                    </div>\n                    <div class=\"node-label\">${window.sanitizeHTML(node.title)}</div>\n                `;\n                frag.appendChild(nodeEl);\n            });\n            canvas.appendChild(frag);\n            canvas.style.height = `${Math.min(lanes.length || 1, MAX_LANES) * 115 + 150}px`;\n        } catch(e) {}\n    }\n\n    function renderList(nodes) {\n        const container = document.getElementById('listContent'); container.innerHTML = \"\";\n        const frag = document.createDocumentFragment();\n        nodes.filter(n => n.source !== 'ai').forEach(node => {\n            const item = document.createElement('div');\n            item.className = 'list-item';\n            const ctx = window.getTemporalContext(node.date);\n            item.innerHTML = `\n                <div class=\"list-icon-circle\" style=\"width:34px; height:34px; border:2.5px solid var(--dn-neutral-light); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0;\">${node.normalizedType === 'note' && node.initials ? `<span style=\"font-size:10px; font-weight:800\">${node.initials}</span>` : (ICONS[node.normalizedType] || ICONS.default)}</div>\n                <div class=\"list-card\" role=\"button\" tabindex=\"0\">\n                    <div style=\"display:flex; justify-content:space-between; align-items: flex-start;\"><div style=\"flex:1;\"><span style=\"font-weight:600;\">${window.sanitizeHTML(node.title)}</span></div><span style=\"font-size:11px; color:var(--dn-neutral-secondary); background:var(--dn-neutral-light); padding:2px 6px; border-radius:4px;\">${ctx.d}</span></div>\n                    <div style=\"font-size:11px; color:var(--dn-neutral-primary); font-weight:600; margin-top:4px;\">${window.sanitizeHTML(node.displayName)}</div>\n                </div>\n            `;\n            item.querySelector('.list-card').addEventListener('click', () => window.showDetails(node.id));\n            frag.appendChild(item);\n        });\n        container.appendChild(frag);\n    }\n\n    window.setFontSize = (sz, btn) => {\n        STATE.panelFontSize = sz;\n        document.querySelectorAll('.readability-btn').forEach(b => b.classList.remove('active'));\n        if (btn) btn.classList.add('active');\n        const desc = document.querySelector('.detail-description-html');\n        if (desc) { desc.classList.remove('font-sz-sm', 'font-sz-md', 'font-sz-lg'); desc.classList.add(`font-sz-${sz}`); }\n    };\n\n    window.showDetails = (nodeOrId) => {\n        const node = typeof nodeOrId === 'string' ? STATE.nodes.find(n => n.id === nodeOrId) : nodeOrId;\n        if (!node) return;\n        document.getElementById(\"detailsPlaceholder\").style.display = \"none\";\n        const contentContainer = document.getElementById(\"detailsContent\");\n        contentContainer.style.display = \"block\";\n        document.getElementById('readabilityCtrl').style.visibility = 'visible';\n        contentContainer.innerHTML = \"\"; \n        const section = document.createElement('div');\n        section.className = 'detail-section';\n        const card1 = document.createElement('div');\n        card1.className = 'detail-card';\n        card1.innerHTML = `<span style=\"font-size:11px; text-transform:uppercase; color:var(--dn-neutral-secondary)\">Context Analytics</span><strong style=\"display:block; font-size:14px; margin-bottom:4px;\">${window.sanitizeHTML(node.displayName)}</strong><div class=\"details-grid\"><div class=\"detail-item\"><span class=\"detail-label\">Owner</span><span class=\"detail-value\">${window.sanitizeHTML(node.owner || 'Unknown')}</span></div><div class=\"detail-item\"><span class=\"detail-label\">Status</span><span class=\"detail-value\">${window.sanitizeHTML(node.state || 'N/A')}</span></div></div>`;\n        const card2 = document.createElement('div');\n        card2.className = 'detail-card'; card2.style.background = 'white';\n        const ctx = window.getTemporalContext(node.date);\n        card2.innerHTML = `<div style=\"display:flex; justify-content:space-between;\"><span style=\"font-weight:600;\">${window.sanitizeHTML(node.title)}</span><span style=\"font-size:10px; background:#f3f2f1; padding:2px 6px; border-radius:4px;\">${ctx.d} ${ctx.t}</span></div>`;\n        const descContainer = document.createElement('div');\n        descContainer.className = `detail-description-html font-sz-${STATE.panelFontSize}`;\n        descContainer.innerHTML = window.interpretHTML(node.description, STATE.searchQuery) || \"<em>No content provided.</em>\";\n        card2.appendChild(descContainer);\n        const actions = document.createElement('div');\n        const copyBtn = document.createElement('button');\n        copyBtn.className = 'btn outline'; copyBtn.innerHTML = 'Copy Body';\n        copyBtn.onclick = () => { const el = document.createElement('textarea'); el.value = descContainer.innerText; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); window.notify(\"Copied!\"); };\n        actions.appendChild(copyBtn); card2.appendChild(actions);\n        section.appendChild(card1); section.appendChild(card2);\n        if (node.source !== 'ai') {\n            const actionsGrid = document.createElement('div');\n            actionsGrid.style.display = 'grid'; actionsGrid.style.gridTemplateColumns = '1fr'; actionsGrid.style.gap = '8px';\n            const viewBtn = document.createElement('button');\n            viewBtn.className = 'btn primary'; viewBtn.innerHTML = 'View Record'; \n            viewBtn.onclick = () => window.openRecord(node.entityName, node.id, 1);\n            actionsGrid.appendChild(viewBtn); \n            section.appendChild(actionsGrid);\n        }\n        contentContainer.appendChild(section);\n        document.getElementById(\"detailsBody\").scrollTop = 0;\n    };\n\n    window.openRecord = (logicalName, id, targetType) => {\n        const Xrm = window.safeGetXrm();\n        if (!Xrm || !Xrm.Navigation) return;\n        const cleanId = id.replace(/{|}/g, \"\");\n        let targetEntity = logicalName || 'activitypointer';\n        if (logicalName === 'note') targetEntity = 'annotation';\n        const pageInput = { pageType: \"entityrecord\", entityName: targetEntity, entityId: cleanId };\n        const options = targetType === 2 ? { target: 2 } : { target: 2, position: 1, width: { value: 95, unit: \"%\" }, height: { value: 95, unit: \"%\" } };\n        Xrm.Navigation.navigateTo(pageInput, options).catch(() => {\n            Xrm.Navigation.openForm({ entityName: targetEntity, entityId: cleanId });\n        });\n    };\n\n    window.popOutTimeline = (mode) => {\n        const Xrm = window.safeGetXrm();\n        const search = encodeURIComponent(STATE.searchQuery);\n        const currentId = window.getUrlParameter('id') || window.getUrlParameter('recordId');\n        const url = `${window.location.href.split('?')[0]}?id=${currentId}&days=${STATE.daysFilter}&search=${search}&tab=${STATE.activeTab}&popped=true`;\n        if (mode === 'tab') { window.open(url, '_blank'); } \n        else if (Xrm && Xrm.Navigation) {\n            let resourceName = \"activity_timeline.html\"; \n            try { const loc = window.location.href; if (loc.includes('webresources/')) resourceName = loc.split('webresources/')[1].split('?')[0].split('#')[0]; } catch(e){}\n            const pageInput = { pageType: \"webresource\", webresourceName: resourceName, data: `id=${currentId}&days=${STATE.daysFilter}&search=${search}&tab=${STATE.activeTab}&popped=true` };\n            Xrm.Navigation.navigateTo(pageInput, { target: 2, position: 1, width: { value: 98, unit: \"%\" }, height: { value: 98, unit: \"%\" } }).catch(() => window.open(url, '_blank'));\n        }\n    };\n\n    window.normalizeType = (v, sub = \"\", desc = \"\") => {\n        let b = 'custom'; const t = (sub + ' ' + desc).toLowerCase();\n        if (typeof v === 'string') { const s = v.toLowerCase(); if (['phonecall','email','task','appointment','chat','incidentresolution','annotation','adx_portalcomment','letter','voicemail'].includes(s)) b = s === 'incidentresolution' ? 'system' : (s === 'annotation' ? 'note' : s); } \n        else { const m = { 4210: 'phonecall', 4200: 'email', 4202: 'task', 4201: 'appointment', 4216: 'chat', 4207: 'letter', 4214: 'voicemail' }; b = m[v] || 'custom'; }\n        if (['phonecall','email','chat','appointment','note','adx_portalcomment','letter','voicemail'].includes(b)) return b;\n        if (['workflow','auto-generated','resolution'].some(k => t.includes(k))) return 'system';\n        return b;\n    };\n\n    window.handleFilterChange = () => { STATE.nodes = []; STATE.daysFilter = document.getElementById('daysFilter').value; window.bootstrap(); };\n    window.handleZoomChange = () => { STATE.canvasWidth = document.getElementById('zoomSlider').value; window.render(); };\n    window.handleTimeToggle = () => { STATE.showTime = document.getElementById('timeToggle').checked; window.render(); };\n    window.handleSearch = () => { if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { STATE.searchQuery = document.getElementById('searchInput').value; window.render(); }, 150); };\n    window.notify = (m) => { const h = document.getElementById(\"notificationHost\"); const e = document.createElement(\"div\"); e.className = \"notification\"; e.innerText = m; h.appendChild(e); setTimeout(()=>e.remove(), 2500); };\n    \n    /** v2.7.0 Integrated Diagnostic Toggle */\n    window.toggleDiagnostics = () => { \n        const el = document.getElementById('diagnosticConsole'); \n        if (el) el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; \n    };\n    \n    window.copyLogs = () => { \n        const text = document.getElementById('diagLog').innerText; \n        const ta = document.createElement('textarea'); ta.value = text; \n        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); \n        document.body.removeChild(ta); window.notify(\"Logs copied!\"); \n    };\n\n    window.getSampleData = () => {\n        const n = new Date(); const d = (v) => new Date(n - 1000*60*60*24*v);\n        return [\n            { id: \"1\", title: \"Archive History Sync\", description: \"Internal project baseline data.\", date: d(10), normalizedType: \"note\", displayName: \"Note\", entityName: \"annotation\", state: \"Completed\", owner: \"Brad Law\", initials: \"BL\" },\n            { id: \"2\", title: \"Diagnostic Session\", description: \"<div><strong>HTML Interpretation Active</strong><p>Summary formatting enabled.</p></div>\", date: d(1), normalizedType: \"appointment\", displayName: \"Appointment\", entityName: \"appointment\", state: \"Scheduled\", owner: \"Support Tier 1\" }\n        ];\n    };\n\n    document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); document.getElementById('searchInput').focus(); } if (e.key === 'Escape') { const s = document.getElementById('searchInput'); if (s.value !== \"\") { s.value = \"\"; STATE.searchQuery = \"\"; window.render(); } } });\n\n    document.getElementById('btnSync').addEventListener('click', window.bootstrap);\n    document.getElementById('btnExport').addEventListener('click', window.exportToCSV);\n    document.getElementById('btnPopoutTab').addEventListener('click', () => window.popOutTimeline('tab'));\n    document.getElementById('btnPopoutDialog').addEventListener('click', () => window.popOutTimeline('dialog'));\n    document.getElementById('btnCloseWindow').addEventListener('click', () => { \n        const Xrm = window.safeGetXrm(); if (Xrm && Xrm.Navigation && Xrm.Navigation.close) Xrm.Navigation.close(); else window.close();\n    });\n\n    // Initialize environment policies and bootstrap\n    window.applyEnvironmentPolicies();\n    window.bootstrap();\n</script>\n</body>\n</html>"
}