{
  "name": "Dynamics Activity Timeline",
  "version": "3.1.3",
  "description": "Removed Open in Tab, Sync not working.",
  "category": "Generic.ActivityTimeline",
  "language": "html",
  "status": "final",
  "tags": [],
  "timestamp": "2026-02-07T20:38:40.975Z",
  "code": "<!--\n * ============================================================\n * VERSION CONTROL BLOCK â€” AUTHORITATIVE BASELINE\n * ============================================================\n * Component: Dynamics Activity Timeline (Single-File Web Resource)\n *\n * Baseline Version: v3.1.3 (Execution Registry Fix)\n * Status: FINAL / LOCKED / BIFURCATED DATA\n *\n * Last Confirmed State:\n * - Journey + List dual-view implementation\n * - Intelligence Panel with tag-safe rich-text interpretation\n * - v3.1.3 Update: Removed DOMContentLoaded (Ensures button parity).\n * - v3.1.3 Update: Fixed Time Toggle (Immediate window-scoped registry).\n * - v3.1.3 Update: Fixed Sync Button (Immediate listener binding).\n * - v3.1.3 Update: Deep-Scan Identity Engine (Workspace parity).\n * - v3.1.3 Update: Logical Name parity (gensoft_sentimentscore).\n *\n * Architectural Invariants (DO NOT BREAK):\n * - ALL utility functions MUST be registered to window at start of script.\n * - Custom fields MUST use lowercase logical names (gensoft_sentimentscore).\n * - Popped/Modal views MUST skip range filtering to show full history.\n * ============================================================\n-->\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"/>\n    <title>Dynamics Activity Timeline</title>\n\n    <style>\n        :root {\n            --dn-blue: #0078d4;\n            --dn-blue-hover: #005a9e;\n            --dn-neutral-primary: #323130;\n            --dn-neutral-secondary: #605e5c;\n            --dn-neutral-lighter: #f3f2f1;\n            --dn-neutral-light: #edebe9;\n            --dn-white: #ffffff;\n            --dn-border-radius: 4px;\n            --dn-shadow: 0 1.6px 3.6px rgba(0,0,0,0.132), 0 0.3px 0.9px rgba(0,0,0,0.108);\n            --state-completed: #107c10;\n            --state-open: #ffaa44;\n            --state-canceled: #a19f9d;\n            --track-color: #d2d0ce;\n            --node-size: 34px;\n            --lane-max: 12;\n        }\n\n        html, body { height: 100%; margin: 0; font-family: \"Segoe UI\", -apple-system, sans-serif; background-color: var(--dn-white); color: var(--dn-neutral-primary); overflow: hidden; }\n        .container { display: flex; flex-direction: column; height: 100vh; padding: 15px; box-sizing: border-box; gap: 10px; position: relative; }\n\n        .skip-link { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; background: var(--dn-blue); color: white; z-index: 10000; }\n        .skip-link:focus { position: fixed; left: 10px; top: 10px; width: auto; height: auto; padding: 10px 20px; border-radius: 4px; outline: 3px solid white; }\n\n        .btn-close-canvas { position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; border-radius: 50%; background: var(--dn-white); border: 1px solid var(--dn-neutral-light); display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 2000; transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); color: var(--dn-neutral-secondary); box-shadow: var(--dn-shadow); }\n        .btn-close-canvas:hover { background: #fde7e9; color: #d13438; border-color: #d13438; transform: rotate(90deg) scale(1.1); }\n        .btn-close-canvas svg { width: 18px; height: 18px; }\n\n        #diagnosticConsole { position: fixed; bottom: 40px; left: 0; right: 0; height: 220px; background: #1e1e1e; color: #d4d4d4; padding: 0; z-index: 4000; display: none; flex-direction: column; font-family: \"Consolas\", monospace; font-size: 11px; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); border-top: 1px solid #444; }\n        .diag-header { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 6px 15px; border-bottom: 1px solid #444; flex-shrink: 0; }\n        .diag-log { flex: 1; overflow-y: auto; white-space: pre-wrap; line-height: 1.4; padding: 10px 15px; }\n\n        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--dn-neutral-light); padding-bottom: 10px; flex-shrink: 0; gap: 15px; flex-wrap: wrap; padding-right: 45px; }\n        .title-group { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }\n        .main-title { font-size: 17px; font-weight: 600; white-space: nowrap; }\n        .record-name-subtitle { font-size: 13px; color: var(--dn-neutral-secondary); font-weight: 400; padding-left: 10px; border-left: 2px solid var(--dn-neutral-light); max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n        .tab-switcher { display: flex; background: var(--dn-neutral-lighter); padding: 3px; border-radius: 8px; border: 1px solid var(--dn-neutral-light); margin-left: 5px; }\n        .tab-btn { padding: 4px 16px; font-size: 13px; border: none; background: none; cursor: pointer; border-radius: 4px; color: var(--dn-neutral-secondary); transition: all 0.2s; }\n        .tab-btn.active { background: var(--dn-white); color: var(--dn-blue); font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }\n        .badge { font-size: 11px; background: var(--dn-blue); color: white; padding: 2px 10px; border-radius: 12px; font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.2); line-height: 1; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; }\n\n        .filter-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; padding: 4px 0; flex-shrink: 0; }\n        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }\n        .type-chip { padding: 4px 14px; border-radius: 16px; font-size: 12px; background: var(--dn-white); border: 1px solid var(--dn-neutral-light); cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s ease; user-select: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }\n        .type-chip.active { background: var(--dn-neutral-primary); color: var(--dn-white); border-color: var(--dn-neutral-primary); font-weight: 600; }\n        .control-group { display: flex; align-items: center; gap: 8px; background: var(--dn-neutral-lighter); padding: 4px 14px; border-radius: 24px; border: 1px solid var(--dn-neutral-light); flex-wrap: wrap; }\n        input[type=\"text\"] { padding: 6px 14px; border: 1px solid var(--dn-neutral-light); border-radius: 18px; font-size: 13px; width: 180px; outline: none; transition: border-color 0.2s; }\n        \n        .content-grid { display: grid; grid-template-columns: minmax(0, 1fr) 340px; gap: 16px; flex: 1; min-height: 0; overflow: hidden; }\n        .panel { background: var(--dn-white); border: 1px solid var(--dn-neutral-light); border-radius: var(--dn-border-radius); display: flex; flex-direction: column; overflow: hidden; }\n        .panel-header { padding: 10px 16px; background: var(--dn-neutral-lighter); font-weight: 600; font-size: 11px; border-bottom: 1px solid var(--dn-neutral-light); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }\n\n        .details-body { padding: 0; overflow-y: auto; background: var(--dn-white); flex: 1; scrollbar-width: thin; }\n        .detail-section { padding: 14px; }\n        .detail-card { background: var(--dn-neutral-lighter); border: 1px solid var(--dn-neutral-light); border-radius: 6px; padding: 12px; margin-bottom: 12px; }\n        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; padding-top: 12px; border-top: 1px solid var(--dn-neutral-light); }\n        .detail-item { display: flex; flex-direction: column; gap: 8px; } \n        .detail-label { font-size: 9px; font-weight: 800; color: var(--dn-neutral-secondary); text-transform: uppercase; letter-spacing: 0.6px; opacity: 0.8; }\n        .detail-value { font-size: 11px; font-weight: 600; color: var(--dn-neutral-primary); line-height: 1.2; }\n        \n        .readability-controls { display: flex; gap: 4px; background: var(--dn-neutral-light); padding: 2px; border-radius: 4px; }\n        .readability-btn { padding: 2px 8px; font-size: 10px; border: none; background: none; cursor: pointer; border-radius: 2px; transition: all 0.15s; }\n        .readability-btn.active { background: white; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }\n        .detail-description-html { line-height: 1.5; word-wrap: break-word; font-size: 12px; color: var(--dn-neutral-secondary); margin-top: 12px; }\n        .font-sz-sm { font-size: 11px !important; }\n        .font-sz-md { font-size: 13px !important; }\n        .font-sz-lg { font-size: 16px !important; }\n\n        .timeline-viewport { flex: 1; overflow: auto; position: relative; background: #fff; background-image: radial-gradient(var(--dn-neutral-light) 1px, transparent 0); background-size: 40px 40px; outline: none; }\n        .timeline-track { position: absolute; top: 60px; left: 50px; right: 50px; height: 2px; background: var(--track-color); z-index: 1; }\n        .node { position: absolute; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; cursor: pointer; z-index: 2; outline: none; transition: transform 0.2s; }\n        .node:hover { transform: translate(-50%, -50%) scale(1.05); z-index: 10; }\n        .node-icon { width: var(--node-size); height: var(--node-size); background: white; border: 2.5px solid var(--dn-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: var(--dn-shadow); flex-shrink: 0; }\n        .node-side-meta { display: flex; flex-direction: column; font-size: 10px; line-height: 1.1; background: rgba(255,255,255,0.9); padding: 4px 6px; border-radius: 4px; white-space: nowrap; border: 1px solid var(--dn-neutral-light); }\n        .node-label { margin-top: 8px; font-size: 11px; font-weight: 600; text-align: center; color: var(--dn-neutral-primary); background: rgba(255,255,255,0.95); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--dn-neutral-light); box-shadow: 0 1px 2px rgba(0,0,0,0.05); max-width: 100px; white-space: normal; word-wrap: break-word; line-height: 1.1; }\n\n        /* Sentiment Rings */\n        .ring-pos { border-color: #107c10 !important; box-shadow: 0 0 10px rgba(16, 124, 16, 0.4) !important; }\n        .ring-neg { border-color: #d13438 !important; box-shadow: 0 0 10px rgba(209, 52, 56, 0.4) !important; }\n        .ring-neu { border-color: #605e5c !important; }\n\n        .list-viewport { flex: 1; overflow-y: auto; padding: 20px; background: var(--dn-neutral-lighter); min-height: 300px; }\n        .list-item { display: flex; gap: 16px; position: relative; padding-bottom: 24px; align-items: flex-start; }\n        .list-card { flex: 1; background: white; border: 1px solid var(--dn-neutral-light); border-radius: 4px; padding: 12px 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; outline: none; }\n\n        .btn { height: 28px; padding: 0 14px; font-size: 12px; background: var(--dn-white); border: 1px solid var(--dn-neutral-light); border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; gap: 6px; white-space: nowrap; }\n        .btn.primary { background: var(--dn-blue); color: white; border: none; }\n        .btn.outline { border: 1px solid var(--dn-blue); color: var(--dn-blue); }\n        .btn-icon-only { padding: 0; width: 34px; border-radius: 50%; }\n\n        .footer-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; flex-shrink: 0; border-top: 1px solid var(--dn-neutral-light); background: var(--dn-neutral-lighter); }\n        .version-tag { font-size: 10px; color: var(--dn-neutral-secondary); opacity: 0.8; user-select: none; display: flex; align-items: center; gap: 10px; }\n        .btn-debug { font-size: 9px; padding: 2px 8px; border: 1px solid #ccc; background: #eee; cursor: pointer; border-radius: 3px; font-weight: bold; }\n        .data-status-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 10px; border: 1px solid transparent; }\n        .status-live { background: #dff6dd; color: #107c10; border-color: #107c10; }\n        .status-sample { background: #fff4ce; color: #797775; border-color: #797775; }\n\n        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; flex-direction: column; gap: 10px; font-weight: 600; }\n        #notificationHost { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 5px; }\n        .notification { background: #323130; color: white; padding: 12px 16px; border-radius: 4px; font-size: 11px; box-shadow: var(--dn-shadow); }\n        .highlight-mark { background-color: #fff100; color: black; font-weight: bold; border-radius: 2px; padding: 0 1px; }\n\n        .top-scrollbar-wrapper { width: 100%; overflow-x: auto; height: 18px; border-bottom: 1px solid var(--dn-neutral-light); flex-shrink: 0; }\n    </style>\n</head>\n\n<body>\n    <div id=\"notificationHost\"></div>\n\n    <div id=\"diagnosticConsole\">\n        <div class=\"diag-header\">\n            <strong>Modal Authority & Sequential Registry</strong>\n            <div style=\"display:flex; gap:5px\">\n                <button class=\"btn\" style=\"background:#0078d4; color:white; border:none;\" onclick=\"window.copyLogs()\">Copy Logs</button>\n                <button class=\"btn\" style=\"background:none; color:white; border:1px solid #666;\" onclick=\"window.toggleDiagnostics()\">Close</button>\n            </div>\n        </div>\n        <div class=\"diag-log\" id=\"diagLog\">App Initialized...</div>\n    </div>\n\n    <div class=\"container\">\n        <button class=\"btn-close-canvas\" id=\"btnCloseWindow\" title=\"Close this timeline view\">\n            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line><line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line></svg>\n        </button>\n\n        <header class=\"header\">\n            <div class=\"title-group\">\n                <span class=\"main-title\">Activity Journey</span>\n                <span id=\"recordNameSubtitle\" class=\"record-name-subtitle\" style=\"display:none\"></span>\n                <span id=\"countBadge\" class=\"badge\">0</span>\n                <div class=\"tab-switcher\">\n                    <button class=\"tab-btn active\" id=\"tabJourney\" onclick=\"window.switchTab('journey')\">Journey</button>\n                    <button class=\"tab-btn\" id=\"tabList\" onclick=\"window.switchTab('list')\">List</button>\n                </div>\n            </div>\n\n            <div class=\"control-group\">\n                <div class=\"control-item\">\n                    <label for=\"daysFilter\">Range:</label>\n                    <select id=\"daysFilter\" onchange=\"window.handleFilterChange()\" style=\"border:none; background:transparent; font-weight:600; font-size:12px;\">\n                        <option value=\"7\">7 Days</option>\n                        <option value=\"30\" selected>30 Days</option>\n                        <option value=\"90\">90 Days</option>\n                        <option value=\"365\">1 Year</option>\n                    </select>\n                </div>\n                <div class=\"control-item\">\n                    <input type=\"range\" id=\"zoomSlider\" min=\"800\" max=\"4000\" step=\"100\" value=\"1000\" oninput=\"window.handleZoomChange()\">\n                </div>\n                <div class=\"control-item\">\n                    <label style=\"cursor:pointer; display:flex; align-items:center; gap:4px\">\n                        <input type=\"checkbox\" id=\"timeToggle\" onchange=\"window.handleTimeToggle()\">\n                        <span style=\"font-size:11px; font-weight:700\">TIME</span>\n                    </label>\n                </div>\n                <button class=\"btn outline\" id=\"btnExport\">Export</button>\n                <div style=\"display:flex; gap:4px;\">\n                    <button class=\"btn outline btn-icon-only\" id=\"btnPopoutDialog\" title=\"Open Focused Modal\">\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"></rect><line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"></line></svg>\n                    </button>\n                </div>\n                <button class=\"btn primary\" id=\"btnSync\">Sync</button>\n            </div>\n        </header>\n\n        <div class=\"filter-row\">\n            <div id=\"typeFilters\" class=\"filter-chips\"></div>\n            <input type=\"text\" id=\"searchInput\" placeholder=\"Search interactions... (Ctrl+K)\" oninput=\"window.handleSearch()\">\n        </div>\n\n        <div class=\"content-grid\">\n            <section class=\"panel\">\n                <div class=\"panel-header\">\n                    <span id=\"dateRange\">Ready</span>\n                    <span id=\"statusBadge\">Initialized</span>\n                </div>\n                <div id=\"viewJourney\" style=\"display:flex; flex-direction:column; flex:1; min-height:0;\">\n                    <div class=\"top-scrollbar-wrapper\" id=\"topScrollWrapper\"><div id=\"topScrollDummy\"></div></div>\n                    <div id=\"viewport\" class=\"timeline-viewport\" tabindex=\"0\">\n                        <div id=\"timelineCanvas\" style=\"position:relative; height:100%; min-width:1000px; padding-bottom: 120px;\">\n                            <div class=\"timeline-track\"></div>\n                        </div>\n                    </div>\n                </div>\n                <div id=\"viewList\" class=\"list-viewport\" style=\"display:none;\">\n                    <div id=\"listContent\"></div>\n                </div>\n            </section>\n\n            <aside class=\"panel\">\n                <div class=\"panel-header\">\n                    <span>Intelligence Panel</span>\n                    <div class=\"readability-controls\" id=\"readabilityCtrl\" style=\"visibility:hidden\">\n                        <button class=\"readability-btn\" onclick=\"window.setFontSize('sm', this)\">A-</button>\n                        <button class=\"readability-btn active\" onclick=\"window.setFontSize('md', this)\">A</button>\n                        <button class=\"readability-btn\" onclick=\"window.setFontSize('lg', this)\">A+</button>\n                    </div>\n                </div>\n                <div id=\"detailsBody\" class=\"details-body\">\n                    <div class=\"detail-section\" id=\"detailsPlaceholder\">\n                        <p style=\"text-align:center; margin-top:40px; color:var(--dn-neutral-secondary)\">Select a record to analyze metadata.</p>\n                    </div>\n                    <div id=\"detailsContent\" style=\"display:none\"></div>\n                </div>\n            </aside>\n        </div>\n\n        <div class=\"footer-row\">\n            <div class=\"version-tag\">\n                Baseline v3.1.3 (Parity Locked)\n                <button class=\"btn-debug\" onclick=\"window.toggleDiagnostics()\">Diagnostics</button>\n            </div>\n            <span id=\"dataStatusBadge\" class=\"data-status-badge status-sample\">Connecting to Dataverse...</span>\n        </div>\n    </div>\n\n<script>\n    /** 1. STRICT GLOBAL REGISTRY **/\n    window.STATE = { nodes: [], canvasWidth: 1000, daysFilter: 30, showTime: false, activeTab: 'journey', searchQuery: \"\", activeDisplayNames: new Set(), allDisplayNamesFound: new Set(), panelFontSize: 'md' };\n    const ENTITY_MAP = { 4210: 'Phone Call', 4200: 'Email', 4202: 'Task', 4201: 'Appointment', 4216: 'Chat', 4207: 'Letter', 4214: 'Voicemail', 4204: 'Fax' };\n    const ICONS = { phonecall: \"ðŸ“ž\", email: \"âœ‰ï¸\", task: \"âœ…\", appointment: \"ðŸ“…\", chat: \"ðŸ’¬\", system: \"âš™ï¸\", custom: \"ðŸ§©\", sentiment_score: \"ðŸ“Š\", note: \"ðŸ“\", letter: \"âœ‰ï¸\", voicemail: \"ðŸŽ™ï¸\", default: \"ðŸ“„\" };\n\n    /** 2. ATOMIC FUNCTION REGISTRY (Sequential) **/\n    window.diagLog = function(msg, type = 'info') { const el = document.getElementById('diagLog'); if (el) { const d = document.createElement('div'); d.className = `log-${type}`; d.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`; el.appendChild(d); } };\n    window.toggleDiagnostics = function() { const el = document.getElementById('diagnosticConsole'); if (el) el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; };\n    window.copyLogs = function() { const text = document.getElementById('diagLog').innerText; const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); window.notify(\"Logs copied!\"); };\n    window.sanitizeHTML = function(str) { if (!str) return \"\"; const div = document.createElement('div'); div.textContent = String(str); return div.innerHTML; };\n    window.notify = function(m) { const h = document.getElementById(\"notificationHost\"); const e = document.createElement(\"div\"); e.className = \"notification\"; e.innerText = m; h.appendChild(e); setTimeout(()=>e.remove(), 2500); };\n\n    window.getTemporalContext = function(date) {\n        if (!date || isNaN(date.getTime())) return { d: \"Pending\", t: \"\" };\n        return { d: date.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }), t: date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };\n    };\n\n    window.normalizeType = function(v, sub = \"\", desc = \"\") {\n        let b = 'custom'; const t = (String(sub) + ' ' + String(desc)).toLowerCase();\n        if (typeof v === 'string') { const s = v.toLowerCase(); if (['phonecall','email','task','appointment','chat','incidentresolution','annotation','adx_portalcomment','letter','voicemail'].includes(s)) b = s === 'incidentresolution' ? 'system' : (s === 'annotation' ? 'note' : s); } \n        else { const m = { 4210: 'phonecall', 4200: 'email', 4202: 'task', 4201: 'appointment', 4216: 'chat', 4207: 'letter', 4214: 'voicemail' }; b = m[v] || 'custom'; }\n        if (['phonecall','email','chat','appointment','note','adx_portalcomment','letter','voicemail'].includes(b)) return b;\n        if (['workflow','auto-generated','resolution'].some(k => t.includes(k))) return 'system';\n        return b;\n    };\n\n    window.renderJourney = function(nodes) {\n        const canvas = document.getElementById(\"timelineCanvas\");\n        const dummy = document.getElementById(\"topScrollDummy\");\n        if (canvas) canvas.style.minWidth = window.STATE.canvasWidth + \"px\";\n        if (dummy) dummy.style.width = window.STATE.canvasWidth + \"px\";\n        const existing = canvas.querySelectorAll('.node'); existing.forEach(n => n.remove());\n        if (!nodes.length) return;\n        try {\n            const total = nodes.length; const lanes = []; const frag = document.createDocumentFragment();\n            nodes.forEach((node, index) => {\n                const pos = (index / (total <= 1 ? 1 : total - 1)) * 75 + 12.5;\n                let lane = 0; while ((lanes[lane] ?? -999) > (pos - 12) && lane < 12) lane++;\n                lanes[lane] = pos;\n                const el = document.createElement(\"div\"); el.className = \"node\"; el.style.left = `${pos}%`; el.style.top = `${60 + (lane * 115)}px`;\n                el.setAttribute('tabindex', '0'); el.addEventListener('click', () => window.showDetails(node));\n                const ctx = window.getTemporalContext(node.date);\n                const ring = node.normalizedType === 'sentiment_score' ? `ring-${node.sentimentClass}` : '';\n                el.innerHTML = `<div class=\"node-row\"><div class=\"node-icon ${ring}\">${(node.normalizedType === 'note' && node.initials) ? `<span style=\"font-size:10px; font-weight:800\">${node.initials}</span>` : (ICONS[node.normalizedType] || ICONS.default)}</div><div class=\"node-side-meta\"><strong>${ctx.d}</strong>${window.STATE.showTime ? `<span style=\"opacity:0.7\">${ctx.t}</span>` : ''}</div></div><div class=\"node-label\">${window.sanitizeHTML(node.title)}</div>`;\n                frag.appendChild(el);\n            });\n            canvas.appendChild(frag); canvas.style.height = `${Math.min(lanes.length || 1, 12) * 115 + 150}px`;\n        } catch(e) { window.diagLog(\"Journey Failure: \" + e.message, \"err\"); }\n    };\n\n    window.renderList = function(nodes) {\n        const container = document.getElementById('listContent'); if (!container) return;\n        container.innerHTML = \"\"; const frag = document.createDocumentFragment();\n        nodes.filter(n => n.source !== 'ai').forEach(node => {\n            const el = document.createElement('div'); el.className = 'list-item'; const ctx = window.getTemporalContext(node.date);\n            const ring = node.normalizedType === 'sentiment_score' ? `border-color: ${node.sentimentClass === 'pos' ? '#107c10' : (node.sentimentClass === 'neg' ? '#d13438' : '#605e5c')};` : '';\n            el.innerHTML = `<div class=\"list-icon-circle\" style=\"width:34px; height:34px; border:2.5px solid var(--dn-neutral-light); border-radius:50%; display:flex; align-items:center; justify-content:center; flex-shrink:0; ${ring}\">${(node.normalizedType === 'note' && node.initials) ? `<span style=\"font-size:10px; font-weight:800\">${node.initials}</span>` : (ICONS[node.normalizedType] || ICONS.default)}</div><div class=\"list-card\" role=\"button\" tabindex=\"0\"><div style=\"display:flex; justify-content:space-between;\"><span style=\"font-weight:600;\">${window.sanitizeHTML(node.title)}</span><span style=\"font-size:11px; background:var(--dn-neutral-light); padding:2px 6px; border-radius:4px;\">${ctx.d}</span></div><div style=\"font-size:11px; color:var(--dn-neutral-primary); font-weight:600; margin-top:4px;\">${window.sanitizeHTML(node.displayName)}</div></div>`;\n            el.querySelector('.list-card').addEventListener('click', () => window.showDetails(node));\n            frag.appendChild(el);\n        });\n        container.appendChild(frag);\n    };\n\n    window.renderFilters = function() {\n        const container = document.getElementById(\"typeFilters\"); if (!container) return;\n        container.innerHTML = \"\"; const counts = {}; window.STATE.nodes.forEach(n => { if(n.source !== 'ai') counts[n.displayName] = (counts[n.displayName] || 0) + 1; });\n        const allBtn = document.createElement(\"button\");\n        allBtn.className = `type-chip ${window.STATE.activeDisplayNames.size === window.STATE.allDisplayNamesFound.size ? 'active' : ''}`;\n        allBtn.innerHTML = `Show All <span class=\"chip-count\">${Object.values(counts).reduce((a,b)=>a+b, 0)}</span>`;\n        allBtn.onclick = () => { window.STATE.activeDisplayNames = new Set(window.STATE.allDisplayNamesFound); window.renderFilters(); window.render(); };\n        container.appendChild(allBtn);\n        Array.from(window.STATE.allDisplayNamesFound).sort().forEach(name => {\n            const chip = document.createElement(\"button\"); chip.className = `type-chip ${window.STATE.activeDisplayNames.has(name) ? 'active' : ''}`;\n            chip.innerHTML = `${window.sanitizeHTML(name)} <span class=\"chip-count\">${counts[name] || 0}</span>`;\n            chip.onclick = () => { if (window.STATE.activeDisplayNames.has(name)) window.STATE.activeDisplayNames.delete(name); else window.STATE.activeDisplayNames.add(name); window.renderFilters(); window.render(); };\n            container.appendChild(chip);\n        });\n    };\n\n    window.render = function() {\n        const q = window.STATE.searchQuery.toLowerCase();\n        const limit = new Date(); limit.setDate(limit.getDate() - Number(window.STATE.daysFilter));\n        const isDialog = window.location.href.includes('popped=true');\n        const filtered = window.STATE.nodes.filter(n => {\n            const mS = (String(n.title) + ' ' + String(n.description)).toLowerCase().includes(q);\n            const mT = n.source === 'ai' || window.STATE.activeDisplayNames.has(n.displayName);\n            const mR = isDialog ? true : (n.date >= limit);\n            return mS && mT && mR;\n        });\n        const count = document.getElementById('countBadge'); if (count) count.innerText = filtered.filter(n=>n.source!=='ai').length;\n        if (window.STATE.activeTab === 'journey') window.renderJourney(filtered); else window.renderList(filtered);\n    };\n\n    window.switchTab = function(tab) {\n        window.STATE.activeTab = tab;\n        const jBtn = document.getElementById('tabJourney'); const lBtn = document.getElementById('tabList');\n        if (jBtn) jBtn.classList.toggle('active', tab === 'journey');\n        if (lBtn) lBtn.classList.toggle('active', tab === 'list');\n        const jView = document.getElementById('viewJourney'); const lView = document.getElementById('viewList');\n        if (jView) jView.style.display = tab === 'journey' ? 'flex' : 'none';\n        if (lView) lView.style.display = tab === 'list' ? 'block' : 'none';\n        window.render();\n    };\n\n    window.interpretHTML = function(html, query) {\n        if (!html) return \"\";\n        const doc = new DOMParser().parseFromString(html, 'text/html');\n        if (!doc || !doc.body) return String(html);\n        if (query && query.length > 2) {\n            const regex = new RegExp(`(${(query || \"\").replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');\n            const walk = (node) => {\n                if (node.nodeType === 3) {\n                    if (regex.test(node.nodeValue)) {\n                        const span = document.createElement('span');\n                        span.innerHTML = node.nodeValue.replace(regex, '<mark class=\"highlight-mark\">$1</mark>');\n                        node.parentNode.replaceChild(span, node);\n                    }\n                } else { for (let i = 0; i < node.childNodes.length; i++) walk(node.childNodes[i]); }\n            }; walk(doc.body);\n        } return doc.body.innerHTML;\n    };\n\n    window.getRecordIdFromContext = function(Xrm) {\n        const guidRegex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/;\n        const cleanGuid = (v) => v ? (String(v).match(guidRegex)?.[0]?.toLowerCase() || null) : null;\n        const scan = (str) => {\n            if (!str) return null;\n            const p = new URLSearchParams(str.replace(/^[?#]/, ''));\n            const rid = cleanGuid(p.get('id') || p.get('recordid') || p.get('recordId'));\n            if (rid && !['appid', 'formid'].includes(rid)) return rid;\n            if (p.has('data')) {\n                const inner = decodeURIComponent(p.get('data'));\n                const innerRid = scan(inner.includes('=') ? inner : 'id=' + inner);\n                if (innerRid) return innerRid;\n            } return null;\n        };\n        const found = scan(window.location.search) || scan(window.location.hash);\n        if (found) { window.diagLog(\"Identity Locked.\", \"success\"); return found; }\n        try { if (Xrm?.Page?.data?.entity) return cleanGuid(Xrm.Page.data.entity.getId()); } catch(e) {}\n        return null;\n    };\n\n    window.safeGetXrm = function() {\n        try { if (window.Xrm && window.Xrm.WebApi) return window.Xrm; } catch(e) {}\n        try { if (window.parent && window.parent.Xrm && window.parent.Xrm.WebApi) return window.parent.Xrm; } catch (e) {}\n        try { if (window.top && window.top.Xrm && window.top.Xrm.WebApi) return window.top.Xrm; } catch (e) {}\n        return null;\n    };\n\n    window.fetchPagedData = async function(Xrm, entity, query, cap = 600) {\n        try {\n            let res = await Xrm.WebApi.retrieveMultipleRecords(entity, query);\n            let records = [...(res.entities || [])];\n            while (res.nextLink && records.length < cap) {\n                const nextRel = res.nextLink.includes('?') ? '?' + res.nextLink.split('?')[1] : res.nextLink;\n                res = await Xrm.WebApi.retrieveMultipleRecords(entity, nextRel); records.push(...(res.entities || []));\n            } return records;\n        } catch(e) { window.diagLog(`Fetch Error on ${entity}: ${e.message}`, \"err\"); return []; }\n    };\n\n    window.bootstrap = async function() {\n        const overlay = document.getElementById('loadingOverlay'); if (overlay) overlay.style.display = 'flex';\n        try {\n            const Xrm = window.safeGetXrm();\n            const regardingId = window.getRecordIdFromContext(Xrm);\n            if (Xrm && regardingId) {\n                const badge = document.getElementById('dataStatusBadge');\n                if (badge) { badge.innerText = \"Live Dataverse Link\"; badge.className = \"data-status-badge status-live\"; }\n                const isDialog = window.location.href.includes('popped=true');\n                const start = new Date(); start.setDate(start.getDate() - Number(window.STATE.daysFilter));\n                const actSelect = `$select=activityid,subject,description,createdon,scheduledstart,activitytypecode,statecode,actualdurationminutes,prioritycode,_regardingobjectid_value,_ownerid_value`;\n                const activityQuery = isDialog ? `?${actSelect}&$filter=(_regardingobjectid_value eq ${regardingId})&$orderby=createdon asc` : `?${actSelect}&$filter=(_regardingobjectid_value eq ${regardingId}) and (createdon ge ${start.toISOString()})&$orderby=createdon asc`;\n                \n                let [activities, notes, phoneData] = await Promise.all([ \n                    window.fetchPagedData(Xrm, \"activitypointer\", activityQuery), \n                    window.fetchPagedData(Xrm, \"annotation\", `?$select=annotationid,subject,notetext,createdon,_ownerid_value&$filter=(_objectid_value eq ${regardingId})&$top=500`),\n                    window.fetchPagedData(Xrm, \"phonecall\", `?$select=activityid,gensoft_sentimentscore&$filter=(_regardingobjectid_value eq ${regardingId})&$top=500`)\n                ]);\n                \n                const sentimentMap = {}; phoneData.forEach(p => { if (p.gensoft_sentimentscore !== null) sentimentMap[p.activityid] = p.gensoft_sentimentscore; });\n                const allRaw = [];\n                activities.forEach(a => {\n                    const d = new Date(a.scheduledstart || a.createdon);\n                    const label = ENTITY_MAP[a.activitytypecode] || a[\"activitytypecode@OData.Community.Display.V1.FormattedValue\"] || \"Interaction\";\n                    allRaw.push({ id: String(a.activityid), title: a.subject || \"No Subject\", description: a.description || \"\", date: d, rawType: a.activitytypecode, entityName: isNaN(Number(a.activitytypecode)) ? a.activitytypecode : (ENTITY_MAP[Number(a.activitytypecode)]?.toLowerCase().replace(' ', '') || 'activitypointer'), normalizedType: window.normalizeType(a.activitytypecode, a.subject, a.description), displayName: label, source: 'dataverse', state: a[\"statecode@OData.Community.Display.V1.FormattedValue\"] || \"\", owner: a[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"] || \"Unknown\" });\n                    if (sentimentMap[a.activityid] !== undefined) { const val = Number(sentimentMap[a.activityid]); allRaw.push({ id: `sent-${a.activityid}`, title: `Sentiment: ${val}`, date: d, rawType: 'sentiment', normalizedType: 'sentiment_score', displayName: 'Sentiment', source: 'dataverse', sentimentClass: val > 5 ? 'pos' : (val < 5 ? 'neg' : 'neu'), owner: \"System\" }); }\n                });\n                notes.forEach(n => { allRaw.push({ id: String(n.annotationid), title: n.subject || \"Note Entry\", description: n.notetext || \"No content.\", date: new Date(n.createdon), rawType: \"annotation\", normalizedType: \"note\", displayName: \"Note\", entityName: \"annotation\", source: 'dataverse', state: \"Notes\", owner: n[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"] || \"Unknown\", initials: window.getInitials(n[\"_ownerid_value@OData.Community.Display.V1.FormattedValue\"]) }); });\n                window.STATE.nodes = allRaw.sort((a,b) => a.date - b.date);\n            } else { \n                const badge = document.getElementById('dataStatusBadge');\n                if (badge) { badge.innerText = \"Demo Mode: Check Record Access\"; badge.className = \"data-status-badge status-sample\"; }\n                window.STATE.nodes = [{ id: \"1\", title: \"Baseline Configuration Session\", description: \"Internal interaction stream.\", date: new Date(), normalizedType: \"note\", displayName: \"Note\", entityName: \"annotation\", state: \"Completed\", owner: \"Brad Law\", initials: \"BL\" }];\n            }\n            window.STATE.allDisplayNamesFound = new Set(window.STATE.nodes.map(n => n.displayName));\n            if (window.STATE.activeDisplayNames.size === 0) window.STATE.activeDisplayNames = new Set(window.STATE.allDisplayNamesFound);\n            window.renderFilters(); window.switchTab(window.STATE.activeTab);\n        } catch (e) { window.diagLog(`Sync Failure: ${e.message}`, \"err\"); }\n        finally { if (overlay) overlay.style.display = 'none'; }\n    };\n\n    /** 3. INTERACTIVE HANDLERS **/\n    window.showDetails = function(nodeOrId) {\n        const node = typeof nodeOrId === 'string' ? window.STATE.nodes.find(n => n.id === nodeOrId) : nodeOrId;\n        if (!node) return;\n        const ph = document.getElementById(\"detailsPlaceholder\"); if (ph) ph.style.display = \"none\";\n        const cont = document.getElementById(\"detailsContent\"); if (cont) cont.style.display = \"block\";\n        const rd = document.getElementById('readabilityCtrl'); if (rd) rd.style.visibility = 'visible';\n        if (cont) {\n            cont.innerHTML = `<div class=\"detail-section\"><div class=\"detail-card\"><strong style=\"display:block; font-size:14px; margin-bottom:4px;\">${window.sanitizeHTML(node.displayName)}</strong><div class=\"details-grid\"><div class=\"detail-item\"><span class=\"detail-label\">Owner</span><span class=\"detail-value\">${window.sanitizeHTML(node.owner || 'Unknown')}</span></div><div class=\"detail-item\"><span class=\"detail-label\">Status</span><span class=\"detail-value\">${window.sanitizeHTML(node.state || 'N/A')}</span></div></div></div><div class=\"detail-card\" style=\"background:white;\"><div style=\"display:flex; justify-content:space-between;\"><span style=\"font-weight:600;\">${window.sanitizeHTML(node.title)}</span><span style=\"font-size:10px; background:#f3f2f1; padding:2px 6px; border-radius:4px;\">${node.date.toLocaleDateString()}</span></div><div class=\"detail-description-html font-sz-${window.STATE.panelFontSize}\">${window.interpretHTML(node.description, window.STATE.searchQuery) || \"<em>No content provided.</em>\"}</div></div></div>`;\n            if (node.source !== 'ai' && node.normalizedType !== 'sentiment_score') {\n                const btn = document.createElement('button'); btn.className = 'btn primary'; btn.style.width = '100%'; btn.innerText = 'View Record';\n                btn.onclick = () => { const Xrm = window.safeGetXrm(); if (Xrm && Xrm.Navigation) Xrm.Navigation.navigateTo({ pageType: \"entityrecord\", entityName: (node.entityName === 'note' ? 'annotation' : node.entityName), entityId: node.id.replace(/{|}/g, \"\") }, { target: 2, position: 1, width: { value: 95, unit: \"%\" }, height: { value: 95, unit: \"%\" } }); };\n                cont.querySelector('.detail-section').appendChild(btn);\n            }\n        }\n    };\n\n    window.handleFilterChange = () => { window.STATE.nodes = []; window.STATE.daysFilter = document.getElementById('daysFilter').value; window.bootstrap(); };\n    window.handleZoomChange = () => { window.STATE.canvasWidth = document.getElementById('zoomSlider').value; window.render(); };\n    window.handleTimeToggle = () => { window.STATE.showTime = document.getElementById('timeToggle').checked; window.render(); };\n    window.handleSearch = () => { if (searchTimeout) clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { window.STATE.searchQuery = document.getElementById('searchInput').value; window.render(); }, 150); };\n    window.setFontSize = (sz, btn) => { window.STATE.panelFontSize = sz; document.querySelectorAll('.readability-btn').forEach(b => b.classList.remove('active')); if (btn) btn.classList.add('active'); window.render(); };\n\n    /** 4. BINDING & EXECUTION (Immediate Phase) **/\n    const syncBtn = document.getElementById('btnSync'); if (syncBtn) syncBtn.addEventListener('click', window.bootstrap);\n    const expBtn = document.getElementById('btnExport'); if (expBtn) expBtn.addEventListener('click', () => {\n        const filtered = window.STATE.nodes.filter(n => n.source !== 'ai' && window.STATE.activeDisplayNames.has(n.displayName));\n        const csv = [\"Date,Type,Status,Owner,Subject\", ...filtered.map(n => `\"${n.date.toISOString()}\",\"${n.displayName}\",\"${n.state}\",\"${n.owner}\",\"${n.title}\"`)].join(\"\\n\");\n        const link = document.createElement(\"a\"); link.href = URL.createObjectURL(new Blob([csv], { type: \"text/csv\" })); link.download = `interaction_export.csv`; link.click();\n    });\n    const modBtn = document.getElementById('btnPopoutDialog'); if (modBtn) modBtn.addEventListener('click', () => {\n        const Xrm = window.safeGetXrm(); const id = window.getRecordIdFromContext(Xrm);\n        if (Xrm && Xrm.Navigation) {\n            let resName = \"activity_timeline.html\"; try { const loc = window.location.href; if (loc.includes('webresources/')) resName = loc.split('webresources/')[1].split('?')[0].split('#')[0]; } catch(e){}\n            Xrm.Navigation.navigateTo({ pageType: \"webresource\", webresourceName: resName, data: `id=${id}&popped=true` }, { target: 2, position: 1, width: { value: 98, unit: \"%\" }, height: { value: 98, unit: \"%\" } });\n        }\n    });\n    const clsBtn = document.getElementById('btnCloseWindow'); if (clsBtn) clsBtn.addEventListener('click', () => { const Xrm = window.safeGetXrm(); if (Xrm && Xrm.Navigation && Xrm.Navigation.close) Xrm.Navigation.close(); else window.close(); });\n\n    window.bootstrap();\n</script>\n</body>\n</html>"
}